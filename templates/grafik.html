<!-- ========================================
     Author    : Ahmad Sanusi
     Instagram : @a.saan_
     ======================================== -->


{% extends "navbar.html" %}
{% block content %}

<div class="max-w-7xl mx-auto pt-10 pb-12 px-4 sm:px-6 lg:px-8">
    
    <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-black text-slate-800 tracking-tight">Analitik Kunjungan</h1>
            <p class="text-slate-500 mt-1">Perbandingan data pasien antar unit poliklinik</p>
        </div>
        
        <form method="get" class="flex flex-wrap items-center gap-3 max-w-fit mx-auto md:mx-0">
    
            <div x-data="{ open: false, selected: '{{ bulan }}', label: '' }" 
                 x-init="const months = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember']; label = months[parseInt(selected)]"
                 class="relative w-44">
                <button type="button" @click="open = !open" class="w-full bg-white border border-slate-200 text-slate-700 text-sm rounded-full px-5 py-2.5 flex items-center justify-between focus:ring-2 focus:ring-[#129990] transition-all shadow-sm">
                    <span x-text="label"></span>
                    <input type="hidden" name="bulan" :value="selected">
                    <svg class="h-4 w-4 text-slate-400" :class="open ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
                </button>
                <div x-show="open" @click.away="open = false" x-transition class="absolute z-50 mt-2 w-full bg-white border border-slate-100 rounded-[1.5rem] shadow-xl py-2 overflow-hidden">
                    <div class="max-h-60 overflow-y-auto custom-scrollbar">
                        {% set nama_bulan = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'] %}
                        {% for b in range(1, 13) %}
                            <div @click="selected = '{{ '%02d' % b }}'; label = '{{ nama_bulan[b] }}'; open = false" class="px-5 py-2 text-sm text-slate-600 hover:bg-[#e7f5f4] hover:text-[#129990] cursor-pointer">
                                {{ nama_bulan[b] }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div x-data="{ open: false, selected: '{{ tahun }}' }" class="relative w-32">
                <button type="button" @click="open = !open" class="w-full bg-white border border-slate-200 text-slate-700 text-sm rounded-full px-5 py-2.5 flex items-center justify-between focus:ring-2 focus:ring-[#129990] transition-all shadow-sm">
                    <span x-text="selected"></span>
                    <input type="hidden" name="tahun" :value="selected">
                    <svg class="h-4 w-4 text-slate-400" :class="open ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
                </button>
                <div x-show="open" @click.away="open = false" x-transition class="absolute z-50 mt-2 w-full bg-white border border-slate-100 rounded-[1.5rem] shadow-xl py-2">
                    {% for t in range(2023, 2031) %}
                        <div @click="selected = '{{ t }}'; open = false" class="px-5 py-2 text-sm text-slate-600 hover:bg-[#e7f5f4] hover:text-[#129990] cursor-pointer">
                            {{ t }}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div x-data="{ open: false, selected: '{{ mode }}', label: '{{ mode | capitalize }}' }" class="relative w-40">
                <button type="button" @click="open = !open" class="w-full bg-[#e7f5f4] border border-[#129990] text-[#129990] text-sm rounded-full px-5 py-2.5 flex items-center justify-between focus:ring-2 focus:ring-[#129990] transition-all font-bold">
                    <span x-text="label"></span>
                    <input type="hidden" name="mode" :value="selected">
                    <svg class="h-4 w-4 text-[#129990]" :class="open ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
                </button>
                <div x-show="open" @click.away="open = false" x-transition class="absolute z-50 mt-2 w-full bg-white border border-slate-100 rounded-[1.5rem] shadow-xl py-2 overflow-hidden">
                    <div @click="selected = 'harian'; label = 'Harian'; open = false" class="px-5 py-2 text-sm text-slate-600 hover:bg-[#e7f5f4] hover:text-[#129990] cursor-pointer">Harian</div>
                    <div @click="selected = 'bulanan'; label = 'Bulanan'; open = false" class="px-5 py-2 text-sm text-slate-600 hover:bg-[#e7f5f4] hover:text-[#129990] cursor-pointer">Bulanan</div>
                    <div @click="selected = 'tahunan'; label = 'Tahunan'; open = false" class="px-5 py-2 text-sm text-slate-600 hover:bg-[#e7f5f4] hover:text-[#129990] cursor-pointer">Tahunan</div>
                </div>
            </div>

            <button type="submit" class="bg-[#129990] hover:bg-[#0e7a73] text-white px-8 py-2.5 rounded-full font-bold text-sm transition-all shadow-lg shadow-[#129990]/20 active:scale-95">
                Tampilkan
            </button>

        </form>

        <style>
            .custom-scrollbar::-webkit-scrollbar { width: 5px; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        </style>
    </div>

    <div class="bg-white p-4 md:p-8 rounded-[2rem] shadow-sm border border-slate-100">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                <span class="w-3 h-3 bg-[#129990] rounded-full animate-pulse"></span>
                Visualisasi Data {{ mode | capitalize }}
            </h2>
            <div class="flex gap-2">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Dataset: Terintegrasi</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="p-4 bg-[#e7f5f4] rounded-2xl border border-[#129990]/20 text-center">
                <h3 class="text-sm font-bold text-slate-500">Total Harian</h3>
                <p class="text-2xl font-extrabold text-[#129990]">{{ total_harian }}</p>
            </div>
            <div class="p-4 bg-green-50 rounded-2xl border border-green-100 text-center">
                <h3 class="text-sm font-bold text-slate-500">Total Bulanan</h3>
                <p class="text-2xl font-extrabold text-green-700">{{ total_bulanan }}</p>
            </div>
            <div class="p-4 bg-amber-50 rounded-2xl border border-amber-100 text-center">
                <h3 class="text-sm font-bold text-slate-500">Total Tahunan</h3>
                <p class="text-2xl font-extrabold text-amber-700">{{ total_tahunan }}</p>
            </div>
        </div>

        <div class="relative w-full h-[400px] md:h-[500px]">
            <canvas id="chart"></canvas>
        </div>
    </div>

    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-4 bg-[#e7f5f4] rounded-2xl border border-[#129990]/20 flex items-center gap-4">
            <div class="p-2 bg-[#129990] rounded-lg text-white font-bold text-xs">i</div>
            <p class="text-xs text-[#0e7a73] leading-snug font-medium">Warna grafik merepresentasikan kategori poliklinik yang berbeda.</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script id="chart-data" type="application/json">
{
    "labels": {{ labels | tojson }},
    "datasets": {{ datasets | tojson }}
}
</script>

<script>
const raw = JSON.parse(document.getElementById('chart-data').textContent);

// Palet warna modern dengan warna utama #129990 di urutan pertama
const colors = [
    { bg: 'rgba(37, 99, 235, 0.8)', border: '#2563eb' },   // Blue (Poli 1)
    { bg: 'rgba(16, 185, 129, 0.8)', border: '#10b981' }, // Emerald (Poli 2)
    { bg: 'rgba(245, 158, 11, 0.8)', border: '#f59e0b' },  // Amber (Poli 3)
    { bg: 'rgba(139, 92, 246, 0.8)', border: '#8b5cf6' }, // Violet (Poli 4)
    { bg: 'rgba(239, 68, 68, 0.8)', border: '#ef4444' },  // Red (Poli 5)
    { bg: 'rgba(6, 182, 212, 0.8)', border: '#06b6d4' },  // Cyan (Poli 6)
    { bg: 'rgba(236, 72, 153, 0.8)', border: '#ec4899' }, // Pink (Poli 7)
    { bg: 'rgba(20, 184, 166, 0.8)', border: '#14b8a6' }, // Teal (Poli 8)
    { bg: 'rgba(249, 115, 22, 0.8)', border: '#f97316' }, // Orange (Poli 9)
    { bg: 'rgba(107, 114, 128, 0.8)', border: '#6b7280' }, // Slate (Poli 10)
    { bg: 'rgba(168, 85, 247, 0.8)', border: '#a855f7' }, // Purple (Poli 11)
    { bg: 'rgba(132, 204, 22, 0.8)', border: '#84cc16' }, // Lime (Poli 12)
    { bg: 'rgba(2, 132, 199, 0.8)', border: '#0284c7' },  // Sky (Poli 13)
    { bg: 'rgba(225, 29, 72, 0.8)', border: '#e11d48' },  // Rose (Poli 14)
    { bg: 'rgba(79, 70, 229, 0.8)', border: '#4f46e5' },  // Indigo (Poli 15)
    { bg: 'rgba(101, 163, 13, 0.8)', border: '#65a30d' }  // Green (Poli 16)
];

new Chart(document.getElementById('chart'), {
    type: 'bar',
    data: {
        labels: raw.labels,
        datasets: raw.datasets.map((ds, i) => ({
            ...ds,
            backgroundColor: colors[i % colors.length].bg,
            borderColor: colors[i % colors.length].border,
            borderWidth: 1,
            borderRadius: 8,
            maxBarThickness: 35,
            barPercentage: 0.8,
            categoryPercentage: 0.7
        }))
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                align: 'end',
                labels: {
                    usePointStyle: true,
                    padding: 20,
                    font: { family: 'Inter', size: 12, weight: '600' }
                }
            },
            tooltip: {
                backgroundColor: '#1e293b',
                padding: 12,
                titleFont: { size: 14, weight: 'bold' },
                cornerRadius: 10
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { color: '#f1f5f9', drawBorder: false },
                ticks: { color: '#94a3b8', font: { size: 11 } }
            },
            x: {
                grid: { display: false },
                ticks: { color: '#64748b', font: { size: 11, weight: '500' } }
            }
        }
    }
});
</script>

{% endblock %}